import os
import numpy as np
import tensorflow as tf
from ml.t0_virus_class import FLAGS, get_data, VirusModel


def run_training(train_dir=FLAGS.train_dir,
                 dataset=FLAGS.dataset,
                 seq_len=FLAGS.seq_len,
                 num_hidden=FLAGS.num_hidden):
    train_x, train_y, seq_len = get_data(train_dir, dataset, seq_len)
    vm = VirusModel(seq_len, num_hidden)

    with tf.Session() as sess:
        init_op = tf.initialize_all_variables()
        sess.run(init_op)

        saver = tf.train.Saver()
        save_path = os.path.join(FLAGS.train_dir, 'train')

        os.mkdir(save_path)
        save_path = os.path.join(save_path, 'model.ckpt')

        batch_size = 50
        num_batch = int(len(train_x) / batch_size)

        for i in range(100):
            ptr = 0
            for j in range(num_batch):
                inp, out = train_x[ptr:ptr+batch_size], train_y[ptr:ptr+batch_size]
                ptr += batch_size

                sess.run(vm.opt, feed_dict={vm.X: inp, vm.Y: out})

            if len(train_x) % batch_size != 0:
                    inp, out = train_x[ptr:], train_y[ptr:]
                    sess.run(vm, feed_dict={vm.X: inp, vm.Y: out})

            errors = sess.run(vm.err, feed_dict={vm.X: train_x, vm.Y: train_y})
            print "Epoch - %d, %.1f" % (i, errors * 100)

            if (i + 1) % 10 == 0:
                saver.save(sess, save_path, global_step=i+1)


def main(_):
    run_training()


if __name__ == '__main__':
    tf.app.run()
