import os
import shutil

os.mkdir('data4')

for name in os.listdir('data3'):
    print name

    with open('data3/' + name) as f:
        data = f.read()

    rows = data.split('\n')
    is_virus = rows[0]
    apis = rows[1:]

    size = 1
    while size < len(apis) / 2:
        ptr = 0
        while ptr < len(apis) - size * 2:
            is_pattern = True
            n = 0
            while n < size:
                if apis[ptr + n] != apis[ptr + size + n]:
                    is_pattern = False
                    break
                n += 1

            if is_pattern:
                end = ptr + size + size

                len_apis = len(apis)
                while is_pattern and end + size < len_apis:
                    n = 0
                    while n < size:
                        if apis[ptr + n] != apis[end + n]:
                            is_pattern = False
                            break
                        n += 1
                    end += size

                if not is_pattern:
                    end -= size

                del apis[ptr + size:end]
                apis.insert(ptr + size, -1)
            ptr += 1
        size += 1

    apis = filter(lambda x: x != -1, apis)

    if len(apis) > 5:
        if len(apis) > 100:
            apis = apis[:100]

        with open('data4/' + name, 'w') as f:
            f.write(is_virus + '\n' + '\n'.join(apis))

shutil.rmtree('data3')
